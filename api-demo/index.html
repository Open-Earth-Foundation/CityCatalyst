<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <title>CityCatalyst API demo</title>
  </head>
  <body>
    <h1>CityCatalyst API demo</h1>
    <p>
      <button id="login">Login with CityCatalyst</button>
      <span id="status"></span>
    </p>
    <script>
      async function toChallenge(verifier) {
        const data = new TextEncoder().encode(verifier);
        const hashBuffer = await crypto.subtle.digest("SHA-256", data);
        const hashArray = Array.from(new Uint8Array(hashBuffer));
        const hashString = hashArray.map(b => String.fromCharCode(b)).join("");
        const base64 = btoa(hashString)                                         // standard base64
          .replace(/\+/g, "-")                                                   // URLâ€‘safe
          .replace(/\//g, "_")
          .replace(/=+$/, "");
        return base64;
      }
      async function getAccessToken(
        access_token_url,
        client_id,
        redirect_uri,
        code,
        code_verifier
      ) {
        const params = new URLSearchParams({
          grant_type: "authorization_code",
          client_id,
          redirect_uri,
          code,
          code_verifier
        })
        const res = await fetch(access_token_url, {
          method: "POST",
          headers: {
            "Content-Type": "application/x-www-form-urlencoded"
          },
          body: params.toString()
        })
        if (!res.ok) {
          throw new Error("Response was bad")
        }
        const json = await res.json()
        return json.access_token
      }
      async function getUsername(username_url, token) {
        const res = await fetch(username_url, {
          headers: {
            "Authorization": `Bearer ${token}`,
          }
        })
        if (!res.ok) {
          throw new Error("Response was bad")
        }
        const json = await res.json()
        return json.data.name
      }
      function setStatus(text) {
        document.getElementById("status").textContent = text;
      }
      document.addEventListener("DOMContentLoaded", () => {
        const authorize_url = "http://localhost:3000/authorize/";
        const access_token_url = "http://localhost:3000/api/v0/token/";
        const client_id = "phc7oUo_rq_QmrWX5ZPbZ";
        const redirect_uri = "http://localhost:2000";
        const username_url = "http://localhost:3000/api/v0/user/whoami/"
        const params = new URLSearchParams(window.location.search);
        if (params.get("state")) {
          if (params.get("state") !== sessionStorage.getItem("oauth_state")) {
            setStatus(`Invalid state`);
          } else {
            sessionStorage.removeItem("oauth_state")
            const error = params.get("error");
            const error_description = params.get("error_description")
            if (error) {
              switch (error) {
                case "invalid_request":
                  setStatus((error_description)
                    ? `Invalid request: ${error_description}`
                    : 'Invalid request'
                  );
                  break;
                case "access_denied":
                  setStatus((error_description)
                    ? `Access denied: ${error_description}`
                    : 'Access denied.'
                  );
                  break;
                case "unauthorized_client":
                  setStatus(`Unauthorized client.`);
                  break;
                case "unsupported_response_type":
                  setStatus(`Unsupported response_type parameter.`);
                  break;
                case "invalid_scope":
                  setStatus(`Invalid scope parameter.`);
                  break;
                case "server_error":
                  setStatus((error_description)
                    ? `The CityCatalyst server had an error: ${error_description}`
                    : 'The CityCatalyst server had an error.'
                  );
                  break;
                case "temporarily_unavailable":
                  setStatus(
                    `The CityCatalyst server is temporarily unavailable.`
                  );
                  break;
              }
            } else {
              const code = params.get("code");
              const code_verifier = sessionStorage.getItem("oauth_code_verifier")
              sessionStorage.removeItem("oauth_code_verifier")
              getAccessToken(
                access_token_url,
                client_id,
                redirect_uri,
                code,
                code_verifier
              ).then(
                (token) => {
                  getUsername(username_url, token)
                  .then((username) => {
                    setStatus(`Hello, ${username}!`)
                  })
                }
              ).catch((err) => {
                setStatus(err.message)
              })
            }
          }
        }
        document.getElementById("login").addEventListener("click", async () => {
          setStatus("Logging in...");
          const state = crypto.randomUUID();
          sessionStorage.setItem("oauth_state", state)
          const code_verifier = crypto.randomUUID();
          sessionStorage.setItem("oauth_code_verifier", code_verifier);
          const code_challenge = await toChallenge(code_verifier);
          const params = new URLSearchParams({
            client_id,
            redirect_uri,
            response_type: "code",
            code_challenge,
            code_challenge_method: "S256",
            state,
            scope: "read write",
          });
          window.location = `${authorize_url}?${params}`;
        });
      });
    </script>
  </body>
</html>
