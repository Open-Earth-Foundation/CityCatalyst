import React, { useState, useMemo, useEffect } from "react";
import {
  Box,
  Button,
  CheckboxGroup,
  createListCollection,
  HStack,
  ProgressCircle,
  Separator,
  Text,
} from "@chakra-ui/react";
import {
  NativeSelectField,
  NativeSelectRoot,
} from "@/components/ui/native-select";
import { MdPersonAdd } from "react-icons/md";
import { TitleLarge } from "@/components/package/Texts/Title";
import { BodyLarge } from "@/components/package/Texts/Body";
import { HeadlineSmall } from "@/components/package/Texts/Headline";
import {
  useCreateOrganizationInviteMutation,
  useGetProjectsQuery,
  useGetUserProjectsQuery,
  useInviteUsersMutation,
} from "@/services/api";
import LabelLarge from "@/components/package/Texts/Label";
import MultipleEmailInput from "./MultipleEmailInput";
import { UseErrorToast, UseSuccessToast } from "@/hooks/Toasts";
import { useTranslation } from "@/i18n/client";
import {
  DialogBody,
  DialogCloseTrigger,
  DialogContent,
  DialogFooter,
  DialogHeader,
  DialogRoot,
} from "@/components/ui/dialog";
import { Checkbox } from "@/components/ui/checkbox";
import {
  SelectContent,
  SelectItem,
  SelectItemGroup,
  SelectLabel,
  SelectRoot,
  SelectTrigger,
  SelectValueText,
} from "@/components/ui/select";
import Callout from "@/components/ui/callout";
import { toaster } from "@/components/ui/toaster";
import { OrganizationRole } from "@/util/types";
import { trackEvent } from "@/lib/analytics";

const AddCollaboratorsDialog = ({
  lng,
  isOpen,
  onClose,
  onOpen,
  organizationId,
}: {
  lng: string;
  isOpen: boolean;
  onClose: () => void;
  onOpen?: () => void;
  organizationId?: string;
}) => {
  const { t } = useTranslation(lng, "dashboard");

  const { showSuccessToast } = UseSuccessToast({
    title: t("invite-success-toast-title"),
    description: t("invite-success-toast-description"),
  });

  const { showErrorToast } = UseErrorToast({
    title: t("invite-error-toast-title"),
    description: t("invite-error-toast-description"),
  });

  // if organizationId is provided, we fetch the projects for that organization only
  // if no organizationId is provided, we fetch the user's projects

  const {
    data: organizationProjectsData,
    isLoading: isLoadingOrganizationProjects,
  } = useGetProjectsQuery(
    {
      organizationId: organizationId as string,
    },
    {
      skip: !organizationId,
    },
  );

  const { data: projectsData, isLoading } = useGetUserProjectsQuery({});


  const projectCollection = useMemo(() => {
    return createListCollection({
      items:
        (organizationProjectsData ?? projectsData)?.map((project) => ({
          label: project.name,
          value: project.projectId,
        })) ?? [],
    });
  }, [projectsData, organizationProjectsData]);


  const [inviteUsers, { isLoading: isInviteUsersLoading }] =
    useInviteUsersMutation();
  const [createOrganizationInvite, { isLoading: isAdminInviteLoading }] =
    useCreateOrganizationInviteMutation();

  const [emails, setEmails] = useState<string[]>([]);
  const [selectedCities, setSelectedCities] = useState<string[]>([]);
  const [selectedProject, setSelectedProject] = useState<string[]>([]);
  const [role, setRole] = useState<string>("collaborator");

  useEffect(() => {
    if (role === "admin") {
      setSelectedCities([]);
      setSelectedProject([]);
    }
  }, [role]);

  const handleCityChange = (city: string) => {
    setSelectedCities((prevSelectedCities) =>
      prevSelectedCities.includes(city)
        ? prevSelectedCities.filter((c) => c !== city)
        : [...prevSelectedCities, city],
    );
  };

  const checkAllCities = () => {
    if (selectedCities.length === cityData?.length) {
      setSelectedCities([]);
    } else {
      setSelectedCities(cityData?.map((city) => city.cityId));
    }
  };

  const onSendInvitesClick = async (): Promise<void> => {
    const { data, error } = await inviteUsers({
      cityIds: selectedCities,
      emails,
    });
    if (data?.success && !error) {
      // Get city names for the selected cities
      const selectedCityNames =
        cityData
          ?.filter((city) => selectedCities.includes(city.cityId))
          ?.map((city) => city.name) || [];

      // Track collaborator invitation
      trackEvent("collaborator_invited", {
        num_invitees: emails.length,
        num_cities: selectedCities.length,
        city_ids: selectedCities,
        city_names: selectedCityNames,
        role: "collaborator",
      });

      showSuccessToast();
      setEmails([]);
      setSelectedCities([]);
      onClose();
    } else {
      showErrorToast();
    }
  };

  const onAdminInviteClick = async () => {
    const inviteResponse = await createOrganizationInvite({
      organizationId: organizationId as string,
      inviteeEmails: emails,
      role: OrganizationRole.ORG_ADMIN,
    });
    if (inviteResponse.data) {
      // Track admin invitation
      trackEvent("admin_invited", {
        num_invitees: emails.length,
        organization_id: organizationId,
        role: "admin",
      });

      showSuccessToast();
      onClose();
    } else {
      showErrorToast();
    }
  };

  const closeFunction = () => {
    setEmails([]);
    setSelectedCities([]);
    setSelectedProject([]);
    onClose();
  };

  const cityData = useMemo<
    {
      cityId: string;
      name: string;
    }[]
  >(() => {
    if (!selectedProject || selectedProject.length === 0) return [];

    const projectsToUse = organizationProjectsData ?? projectsData;
    const project = projectsToUse?.find(
      (project) => project.projectId === selectedProject[0],
    );
    return (
      project?.cities.map((city) => ({
        cityId: city.cityId,
        name: city.name,
      })) ?? []
    );
  }, [projectsData, organizationProjectsData, selectedProject]);

  return (
    <DialogRoot
      open={isOpen}
      onOpenChange={closeFunction}
      onExitComplete={onClose}
    >
      <DialogContent minH="300px" minW="600px" marginTop="2%" p={0}>
        <DialogHeader
          display="flex"
          justifyContent="start"
          fontWeight="semibold"
          fontSize="headline.sm"
          fontFamily="heading"
          lineHeight="32"
          color="base.dark"
          padding="24px"
          borderBottomWidth="2px"
          borderStyle="solid"
          borderColor="background.neutral"
        >
          <HStack>
            <MdPersonAdd fontSize={"32px"} />
            <HeadlineSmall text={t("invite-your-colleagues")} />
          </HStack>
        </DialogHeader>
        <DialogCloseTrigger mt={"2"} color="interactive.control" mr={"2"} />
        <DialogBody p={0}>
          <Box paddingX={6} mt={6}>
            <TitleLarge color="content.tertiary">
              {t("choose-a-role")}
            </TitleLarge>
            <LabelLarge text={t("select-role")} mt={3} />
            <NativeSelectRoot
              variant="outline"
              defaultValue="collaborator"
              marginTop={3}
              w={"60%"}
            >
              <NativeSelectField
                value={role}
                onChange={(e) => {
                  setRole(e.target.value);
                }}
              >
                <option value="collaborator">{t("collaborator")}</option>
                {organizationId && <option value="admin">{t("admin")}</option>}
              </NativeSelectField>
            </NativeSelectRoot>
            <Callout
              p={4}
              mt={4}
              heading={
                role === "admin" ? t("admin-rule") : t("collaborator-rule")
              }
            />
          </Box>
          <Box paddingX={6} mt={6} mb={role === "admin" ? 20 : 6}>
            <TitleLarge color="content.tertiary">
              {t("send-invites")}
            </TitleLarge>
            <Text color="content.tertiary">
              {t("send-invites-description-1")}
              <br />
              {t("send-invites-description-2")}
            </Text>
            <LabelLarge text={t("email")} mt={3} />
            <MultipleEmailInput t={t} emails={emails} setEmails={setEmails} />
          </Box>
          {role !== "admin" && (
            <Box
              display="flex"
              paddingX={6}
              mt={6}
              flexDirection="column"
              gap={3}
              mb={10}
            >
              <TitleLarge color="content.tertiary">
                {t("project-to-share")}
              </TitleLarge>
              {isLoading || isLoadingOrganizationProjects ? (
                <ProgressCircle.Root value={null} size="sm">
                  <ProgressCircle.Circle>
                    <ProgressCircle.Track />
                    <ProgressCircle.Range />
                  </ProgressCircle.Circle>
                </ProgressCircle.Root>
              ) : (
                <SelectRoot
                  value={selectedProject}
                  onValueChange={(e) => setSelectedProject(e.value)}
                  variant="subtle"
                  w="80%"
                  collection={projectCollection}
                >
                  <SelectLabel display="flex" alignItems="center" gap="8px">
                    <Text fontFamily="heading" color="content.secondary">
                      {t("project")}
                    </Text>
                  </SelectLabel>
                  <SelectTrigger>
                    <SelectValueText
                      color="content.tertiary"
                      fontWeight="medium"
                      placeholder={t("select-project")}
                    />
                  </SelectTrigger>
                  <SelectContent portalled={false}>
                    {projectCollection?.items.map((project) => (
                      <SelectItem key={project.value} item={project.value}>
                        {project.label}
                      </SelectItem>
                    ))}
                  </SelectContent>
                </SelectRoot>
              )}
            </Box>
          )}
          {!(selectedProject.length > 0) ? null : (
            <Box paddingX={6}>
              <TitleLarge color="content.tertiary">
                {t("select-cities-to-share")}
              </TitleLarge>
              <BodyLarge>{t("select-cities-to-share-description")}</BodyLarge>
              {cityData?.length === 0 && (
                <Text fontSize="body.md" mt={3} color="content.tertiary">
                  {organizationId && !selectedProject
                    ? t("select-project")
                    : t("no-cities-available")}
                </Text>
              )}
              <Box>
                {cityData?.length > 1 && (
                  <>
                    <Checkbox
                      key="all"
                      my={6}
                      checked={selectedCities.length === cityData?.length}
                      onChange={() => checkAllCities()}
                    >
                      <Text fontWeight="semibold" fontSize="body.lg">
                        {t("all-cities")}
                      </Text>
                    </Checkbox>
                    <Separator borderColor="border.overlay" />
                  </>
                )}
                <CheckboxGroup my="24px">
                  <Box
                    display="grid"
                    gridTemplateColumns={{
                      base: "1fr",
                      sm: "repeat(2, 1fr)",
                      md: "repeat(3, 1fr)",
                    }}
                    gap={4}
                  >
                    {cityData?.map(({ cityId, name }) => (
                      <Checkbox
                        key={cityId}
                        checked={selectedCities.includes(cityId)}
                        onChange={() => handleCityChange(cityId)}
                      >
                        <Text fontWeight="semibold" fontSize="body.lg">
                          {name}
                        </Text>
                      </Checkbox>
                    ))}
                  </Box>
                </CheckboxGroup>
              </Box>
            </Box>
          )}
          <DialogFooter
            paddingX={6}
            paddingY={6}
            borderTop="2px"
            borderColor="background.neutral"
            borderStyle="solid"
          >
            <Box>
              <Button
                disabled={
                  emails.length === 0 ||
                  (role === "collaborator" && selectedCities.length === 0) ||
                  isInviteUsersLoading ||
                  isAdminInviteLoading
                }
                loading={isInviteUsersLoading || isAdminInviteLoading}
                colorScheme="blue"
                onClick={() =>
                  role === "admin" ? onAdminInviteClick() : onSendInvitesClick()
                }
              >
                {t("send-invites")}
              </Button>
            </Box>
          </DialogFooter>
        </DialogBody>
      </DialogContent>
    </DialogRoot>
  );
};

export default AddCollaboratorsDialog;
