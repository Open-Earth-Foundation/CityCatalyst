name: SDK Generator

on:
  push:
    paths:
      - 'app/src/api/**'
      - '.github/workflows/sdk-generator.yml'
  workflow_dispatch:

jobs:
  build-and-generate-openapi-spec:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install app dependencies
        working-directory: app
        run: npm ci

      - name: Build app
        working-directory: app
        run: npm run build

      - name: Upload OpenAPI spec artifact
        uses: actions/upload-artifact@v4
        with:
          name: openapi-spec
          path: app/public/openapi-spec.json

  build-typescript-sdk:
    runs-on: ubuntu-latest
    needs: build-and-generate-openapi-spec

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download OpenAPI spec artifact
        uses: actions/download-artifact@v4
        with:
          name: openapi-spec
          path: app/public

      - name: Generate TypeScript SDK from OpenAPI
        uses: openapi-generators/openapitools-generator-action@v1
        with:
          generator: typescript-fetch
          openapi-file: app/public/openapi-spec.json
          command-args: --skip-validate-spec

      - name: Set up Node.js for npm publish
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          registry-url: 'https://registry.npmjs.org'

      - name: Initialise package
        working-directory: typescript-fetch-client
        run: |
          if [ ! -f package.json ]; then
            npm init --yes \
              --scope=@oef \
              --init-module=citycatalyst \
              --init-version=0.0.1
          fi

      - name: Install npm dependencies
        working-directory: typescript-fetch-client
        run: npm install

      - name: Pack SDK for NPM
        working-directory: typescript-fetch-client
        run: npm pack

      - name: Upload SDK package artifact
        uses: actions/upload-artifact@v4
        with:
          name: citycatalyst-sdk
          path: typescript-fetch-client/*.tgz

  build-python-sdk:
    runs-on: ubuntu-latest
    needs: build-and-generate-openapi-spec

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download OpenAPI spec artifact
        uses: actions/download-artifact@v4
        with:
          name: openapi-spec
          path: app/public

      - name: Generate Python SDK from OpenAPI
        uses: openapi-generators/openapitools-generator-action@v1
        with:
          generator: python
          openapi-file: app/public/openapi-spec.json
          command-args: --skip-validate-spec

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install packaging dependencies
        run: python -m pip install --upgrade pip build twine

      - name: Build Python package
        working-directory: python-client
        run: python -m build

      - name: Upload Python package artifact
        uses: actions/upload-artifact@v4
        with:
          name: citycatalyst-python-sdk
          path: python-client/dist/*

  build-ruby-sdk:
    runs-on: ubuntu-latest
    needs: build-and-generate-openapi-spec

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download OpenAPI spec artifact
        uses: actions/download-artifact@v4
        with:
          name: openapi-spec
          path: app/public

      - name: Generate Ruby SDK from OpenAPI
        uses: openapi-generators/openapitools-generator-action@v1
        with:
          generator: ruby
          openapi-file: app/public/openapi-spec.json
          command-args: --skip-validate-spec

      - name: Set up Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.2'

      - name: Install Ruby dependencies
        working-directory: ruby-client
        run: bundle install

      - name: Build Ruby gem
        working-directory: ruby-client
        run: gem build citycatalyst_client.gemspec

      - name: Upload Ruby gem artifact
        uses: actions/upload-artifact@v4
        with:
          name: citycatalyst-ruby-sdk
          path: ruby-client/citycatalyst_client-*.gem

  build-swift-sdk:
    runs-on: ubuntu-latest
    needs: build-and-generate-openapi-spec

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download OpenAPI spec artifact
        uses: actions/download-artifact@v4
        with:
          name: openapi-spec
          path: app/public

      - name: Generate Swift SDK from OpenAPI
        uses: openapi-generators/openapitools-generator-action@v1
        with:
          generator: swift5
          openapi-file: app/public/openapi-spec.json
          command-args: --skip-validate-spec

      - name: Archive Swift package
        run: tar -czf swift-sdk.tar.gz -C swift5 .

      - name: Upload Swift SDK artifact
        uses: actions/upload-artifact@v4
        with:
          name: citycatalyst-swift-sdk
          path: swift-sdk.tar.gz

  build-kotlin-sdk:
    runs-on: ubuntu-latest
    needs: build-and-generate-openapi-spec

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download OpenAPI spec artifact
        uses: actions/download-artifact@v4
        with:
          name: openapi-spec
          path: app/public

      - name: Generate Kotlin SDK from OpenAPI
        uses: openapi-generators/openapitools-generator-action@v1
        with:
          generator: kotlin
          openapi-file: app/public/openapi-spec.json
          command-args: --skip-validate-spec

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'

      - name: Make Gradle wrapper executable
        working-directory: kotlin-client
        run: chmod +x gradlew

      - name: Build Kotlin package
        working-directory: kotlin-client
        run: ./gradlew assemble

      - name: Upload Kotlin SDK artifact
        uses: actions/upload-artifact@v4
        with:
          name: citycatalyst-kotlin-sdk
          path: kotlin-client/build/libs/*.jar
