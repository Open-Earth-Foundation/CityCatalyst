<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <title>CityCatalyst API demo</title>
  </head>
  <body>
    <h1>CityCatalyst API demo</h1>
    <p>
      <button id="login">Login with CityCatalyst</button>
      <span id="status"></span>
    </p>
    <script type="module">
      import * as oauth from './oauth4webapi.min.js'

      import { config } from './config.js'
      const { CC_ORIGIN, CLIENT_ID } = config

      const APP_ORIGIN = (new URL(window.location)).origin

      const username_url = `${CC_ORIGIN}/api/v0/user/whoami/`

      const redirect_uri = `${APP_ORIGIN}`;

      function setStatus(text) {
        document.getElementById("status").textContent = text;
      }

      async function startLogin (as, client) {
        setStatus("Logging in...");
        const code_verifier = oauth.generateRandomCodeVerifier();
        const code_challenge = await oauth.calculatePKCECodeChallenge(code_verifier);
        const state = oauth.generateRandomState()

        sessionStorage.setItem('code_verifier', code_verifier);
        sessionStorage.setItem('state', state);

        const scope = 'read write'

        const authz = new URL(as.authorization_endpoint)
        authz.searchParams.set('client_id', client.client_id)
        authz.searchParams.set('redirect_uri', redirect_uri)
        authz.searchParams.set('response_type', 'code')
        authz.searchParams.set('scope', 'read write')
        authz.searchParams.set('code_challenge', code_challenge)
        authz.searchParams.set('code_challenge_method', code_challenge_method)
        authz.searchParams.set('state', state)

        window.location.href = authz.toString();
      }

      async function finishLogin (as, client) {
        try {
          const state = sessionStorage.getItem('state')
          const code_verifier = sessionStorage.getItem('code_verifier')

          const params = oauth.validateAuthResponse(
            as,
            client,
            new URL(window.location),
            state
          )

          const response = await oauth.authorizationCodeGrantRequest(
            as,
            client,
            oauth.None(),
            params,
            redirect_uri,
            code_verifier
          )

          const result = await oauth.processAuthorizationCodeResponse(
            as,
            client,
            response
          )

          const { access_token } = result

          sessionStorage.setItem('access_token', access_token)

          sessionStorage.removeItem('state')
          sessionStorage.removeItem('code_verifier')

          window.location.href = redirect_uri
        } catch (error) {
          setStatus(err.message)
          sessionStorage.removeItem('state')
          sessionStorage.removeItem('code_verifier')
        }
      }

      async function showUsername (as) {
        const access_token = sessionStorage.getItem('access_token');
        try {
          let whoamiResponse = await oauth.protectedResourceRequest(
            access_token,
            'GET',
            new URL(username_url),
          )
          let whoami = await whoamiResponse.json()
          setStatus(`Hello, ${whoami.data.name}`);
        } catch (error) {
          setStatus(error.message)
        }
      }

      document.addEventListener("DOMContentLoaded", async () => {
        const client = { client_id: CLIENT_ID }
        const res = await oauth.discoveryRequest(
          new URL(CC_ORIGIN),
          { algorithm: 'oauth2' }
        )
        const as = oauth.processDiscoveryResponse(issuer, response)
        const params = new URLSearchParams(window.location.search)
        if (sessionStorage.getItem('access_token')) {
          await showUsername(as, client)
        } else if (params.get("state")) {
          await finishLogin(as, client)
        }
        document.getElementById("login").addEventListener("click", async () => {
          await startLogin(as, client)
        });
      });
    </script>
  </body>
</html>
