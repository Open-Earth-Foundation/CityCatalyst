<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <title>CityCatalyst API demo</title>
  </head>
  <body>
    <h1>CityCatalyst API demo</h1>
    <p>
      <button id="login">Login with CityCatalyst</button>
      <span id="status"></span>
    </p>
    <script type="module">
      import * as client from 'https://cdn.jsdelivr.net/npm/openid-client@6/+esm'

      import { config } from './config.js'
      const { CC_ORIGIN, CLIENT_ID } = config

      const APP_ORIGIN = (new URL(window.location)).origin

      const username_url = `${CC_ORIGIN}/api/v0/user/whoami/`

      const redirect_uri = `${APP_ORIGIN}`;

      function setStatus(text) {
        document.getElementById("status").textContent = text;
      }

      async function startLogin (disco) {
        setStatus("Logging in...");
        const code_verifier = client.generateRandomCodeVerifier();
        const code_challenge = await client.calculatePKCECodeChallenge(code_verifier);
        const state = crypto.randomUUID()

        sessionStorage.setItem('code_verifier', code_verifier);
        sessionStorage.setItem('state', state);

        const scope = 'read write'

        let parameters = {
          redirect_uri,
          scope,
          code_challenge,
          code_challenge_method: 'S256',
          state
        }

        let redirectTo = client.buildAuthorizationUrl(disco, parameters)

        window.location.href = redirectTo.toString();
      }

      async function finishLogin (disco) {
        try {
          let tokens = await client.authorizationCodeGrant(
            disco,
            window.location,
            {
              pkceCodeVerifier: sessionStorage.getItem('code_verifier'),
              expectedState: sessionStorage.getItem('state'),
            },
          )
        } catch (error) {
          setStatus(err.message)
        }
      }

      async function showUsername (disco) {
        const access_token = sessionStorage.getItem('access_token');
        try {
          let whoamiResponse = await client.fetchProtectedResource(
            disco,
            access_token,
            new URL(username_url),
            'GET',
          )
          let whoami = await whoamiResponse.json()
          setStatus(`Hello, ${whoami.data.name}`);
        } catch (error) {
          setStatus(error.message)
        }
      }

      document.addEventListener("DOMContentLoaded", async () => {
        let disco = await client.discovery(
          CC_ORIGIN,
          CLIENT_ID
        )
        const params = new URLSearchParams(window.location.search);
        if (sessionStorage.getItem('access_token')) {
          await showUsername(disco)
        } else if (params.get("state")) {
          await finishLogin(disco)
        }
        document.getElementById("login").addEventListener("click", async () => {
          await startLogin(disco)
        });
      });
    </script>
  </body>
</html>
