apiVersion: batch/v1
kind: CronJob
metadata:
  name: citycatalyst-check-hiap-jobs
  namespace: default
spec:
  # Run every minute
  schedule: "* * * * *"
  successfulJobsHistoryLimit: 3
  failedJobsHistoryLimit: 3
  concurrencyPolicy: Forbid # Prevent overlapping runs
  jobTemplate:
    spec:
      backoffLimit: 2 # Retry twice on failure
      template:
        metadata:
          labels:
            app: citycatalyst-cron
            job: check-hiap-jobs
        spec:
          restartPolicy: OnFailure
          containers:
            - name: check-hiap-jobs
              image: curlimages/curl:latest
              command:
                - /bin/sh
                - -c
                - |
                  if [ -n "$(CC_CRON_JOB_API_KEY)" ]; then
                    echo "Missing env var CC_CRON_JOB_API_KEY"
                    exit 1
                  fi
                  echo "Checking HIAP jobs at $(date)"
                  curl -f -L --header "Authorization: Bearer $(CC_CRON_JOB_API_KEY)" -X GET http://cc-web:3000/api/v1/cron/check-hiap-jobs
                  EXIT_CODE=$?
                  if [ $EXIT_CODE -eq 0 ]; then
                    echo "Cron job completed successfully"
                  else
                    echo "Cron job failed with exit code $EXIT_CODE"
                    exit $EXIT_CODE
                  fi
